define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/ol3-layerswitcher","core/str"],function(fe,e,t,he,ve,me,ye,o,i){function c(t,o,i,n,a,r){var p="EPSG:3857",e=new ve.proj.Projection(p),s=null,l=!0;if(void 0!==r&&null!=r){if(null!=r.custombackgroundurl){var d=ve.proj.transformExtent(r.bbox,"EPSG:4326",p);if(!r.geographic){d[2],d[0];var c=d[3]-d[1],u=(d[2]+d[0])/2,g=(d[3]+d[1])/2,f=Math.round(c/r.imgheight),h=Math.round(r.imgwidth*f),v=Math.round(r.imgheight*f);d=[u-h/2,g-v/2,u+h/2,g+v/2]}s=new ve.layer.Image({title:r.layername,type:r.layertype,source:new ve.source.ImageStatic({url:r.custombackgroundurl,imageExtent:d}),opacity:1})}else if(null!=r.wmsurl){var m={source:new ve.source.TileWMS({url:r.wmsurl,params:r.wmsparams}),type:r.layertype,title:r.layername};if(null!=r.bbox[0]&&null!=r.bbox[1]&&null!=r.bbox[2]&&null!=r.bbox[3]){var y=ve.proj.transformExtent(r.bbox,"EPSG:4326",p);m.extent=y}s=new ve.layer.Tile(m)}l=r.geographic}var b,w,F,P,C={roads:{}},k=new ve.source.Vector({projection:p}),x=new ve.source.Vector({projection:p}),I=!1,S=!1,E=!1,A={},T=1,B=new ve.layer.Vector({source:new ve.source.Vector({projection:p})}),j=ye.createGeocoder("openstreetmap");function G(e,t,o,i,n,a){var r,s=fe(e).get([o]),l=fe(s).attr("roadid");r=Math.abs(fe(s).index('li[roadid="'+l+'"]')-t),fe(s).attr("stageposition",r),fe(s).find(".sortable-number").text(r),fe(s).hasClass("ui-selected")&&(b=r),function(e,t,o,i,n){var a,r=o.getFeatureById(e);r||((r=i.getFeatureById(e).clone()).setId(e),o.addFeature(r));if(r.setProperties({stageposition:t}),"empty"!==r.get("idFeaturesPolygons")){a=r.get("idFeaturesPolygons").split(",");for(var s=0,l=a.length;s<l;s++)n.getSource().getFeatureById(a[s]).setProperties({stageposition:t})}}(parseInt(fe(s).attr("stageid"),10),r,(parseInt(fe(s).attr("roadid"),10),i),n,a)}fe("#controlpanel").addClass("ui-widget-header ui-corner-all"),fe('<span id="edition"/>').appendTo(fe("#controlpanel")),fe('<input type="radio" name="controlpanel" id="addradio" value="add">').appendTo(fe("#edition")),fe("<label>").attr("for","addradio").text(i.add).appendTo(fe("#edition")),fe('<input type="radio" name="controlpanel" id="modifyradio" value="modify">').appendTo(fe("#edition")),fe("<label>").attr("for","modifyradio").text(i.modify).appendTo(fe("#edition")),fe('<button id="savestage"/>').attr("disabled",!0).text(i.save).appendTo(fe("#controlpanel")),fe('<button id="removefeature"/>').attr("disabled",!0).text(i.remove).appendTo(fe("#controlpanel")),l&&(fe('<div id="searchcontainer">').appendTo(fe("#controlpanel")),fe('<input type="search" placeholder="'+i.searchlocation+'" class="searchaddress"/>').appendTo(fe("#searchcontainer")),fe('<span class="ui-icon  ui-icon-search searchicon"></span>').prependTo(fe("#searchcontainer")),fe('<span class="ui-icon  ui-icon-closethick closeicon invisible"></span>').appendTo(fe("#searchcontainer"))),fe('<button id="addstage" />').text(i.stage).prependTo(fe("#controlpanel")),fe('<button id="addroad" />').text(i.road).prependTo(fe("#controlpanel")),fe("#addradio").button({text:!1,icons:{primary:"ui-icon-plusthick"}}),fe("#modifyradio").button({text:!1,icons:{primary:"ui-icon-pencil"}}),fe("#removefeature").button({text:!1,icons:{primary:"ui-icon-trash"}}),fe("#savestage").button({text:!1,icons:{primary:"ui-icon-disk"}}),fe("#addstage").button({icons:{primary:"ui-icon-circle-plus"}}),fe("#addroad").button({icons:{primary:"ui-icon-circle-plus"}}),fe("#edition").buttonset({disabled:!0}),fe("#controlpanel").removeClass("invisible"),fe('<ul id="stagelist"/>').prependTo(fe("#stagelistpanel")),fe("#stagelist").sortable({handle:".handle",tolerance:"pointer",zIndex:9999,opacity:.5,forcePlaceholderSize:!0,cursorAt:{top:-7},cursor:"n-resize",axis:"y",items:"li:not(:hidden , .blocked)",helper:"clone",start:function(e,t){var o=t.item.attr("roadid"),i=t.item.index('li[roadid="'+o+'"]'),n=fe(this).data("ui-sortable").scrollParent,a=n[0].scrollHeight-n[0].clientHeight-t.helper.height();t.item.data("start_pos",i),fe(this).data("maxScrollTop",a)},sort:function(e,t){var o=fe(this).data("ui-sortable").scrollParent,i=fe(this).data("maxScrollTop");o.scrollTop()>i&&o.scrollTop(i)},update:function(e,t){var o,i=t.item.data("start_pos"),n=t.item.attr("roadid"),a=t.item.index('li[roadid="'+n+'"]'),r=fe(this).children('li[roadid="'+n+'"]'),s=fe(r).length;if(i!==a){if(i<a)for(o=i;o<=a;o++)G(r,s,o,k,x,C.roads[n].vector);else for(o=a;o<=i;o++)G(r,s,o,k,x,C.roads[n].vector);oe(),I=!0}}}).disableSelection(),fe('<ul id="roadlist"/>').appendTo(fe("#roadlistpanel")),window.app={};var _=window.app;_.generateResizableControl=function(e){var t=e||{},o=document.createElement("button"),i=document.createElement("div");o.innerHTML="<>",o.id="egrip",i.className="ol-control ol-unselectable egrip-container",i.appendChild(o),ve.control.Control.call(this,{element:i,target:t.target})},ve.inherits(_.generateResizableControl,ve.control.Control);var z=new ve.style.Style({fill:new ve.style.Fill({color:"rgba(0, 0, 0, 0.1)"}),stroke:new ve.style.Stroke({color:"#6C0492",width:2}),image:new ve.style.Circle({radius:5,fill:new ve.style.Fill({color:"#ffcc33"}),stroke:new ve.style.Stroke({color:"#000000",width:2})}),text:new ve.style.Text({textAlign:"center",scale:1.3,fill:new ve.style.Fill({color:"#fff"}),stroke:new ve.style.Stroke({color:"#6C0492",width:3.5})})}),L=new ve.style.Style({fill:new ve.style.Fill({color:"rgba(0, 0, 0, 0.05)"}),stroke:new ve.style.Stroke({color:"#FAC30B",width:2}),image:new ve.style.Circle({radius:5,fill:new ve.style.Fill({color:"#ffcc33"}),stroke:new ve.style.Stroke({color:"#000000",width:2})}),text:new ve.style.Text({textAlign:"center",scale:1.3,fill:new ve.style.Fill({color:"#fff"}),stroke:new ve.style.Stroke({color:"#ffcc33",width:3.5})}),zIndex:"Infinity"}),M=new ve.layer.Vector({source:new ve.source.Vector({projection:"EPSG:3857"}),visible:!1}),V=new ve.layer.Group({title:i.basemaps,layers:[new ve.layer.Tile({title:i.aerialmap,type:"base",visible:!1,source:new ve.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new ve.layer.Tile({title:i.roadmap,type:"base",visible:!0,source:new ve.source.OSM})]});null!=s&&(r.onlybase&&V.getLayers().clear(),V.getLayers().push(s));var O=document.getElementById("popup"),D=document.getElementById("popup-content"),H=document.getElementById("popup-closer"),N=new ve.Overlay({element:O,autoPan:!0,autoPanAnimation:{duration:250}});H.onclick=function(){return N.setPosition(void 0),H.blur(),!1};var W=new ve.control.LayerSwitcher,q=new ve.Map({layers:[V,M],overlays:[N],projection:e,renderer:"canvas",target:"mapedit",view:new ve.View({center:[0,0],zoom:2,minZoom:2}),controls:ve.control.defaults().extend([W,new _.generateResizableControl({target:document.getElementById("stagelistpanel")})])});q.on("click",function(e){var t,o,i,n;K.getActive()||R.getActive()||null!==r&&!r.geographic||(t=e.coordinate,o=ve.proj.toLonLat(t,q.getView().getProjection()),i=ve.coordinate.toStringHDMS(o),n='<a target="street" href="http://maps.google.com/?cbll='+o[1]+","+o[0]+'&cbp=12,20.09,,0,5&layer=c"><img src="pix/my_location.png" width="16" /></a>',D.innerHTML="<code>"+n+i+"</code>",N.setPosition(t))}),W.showPanel(),fe("#stagelistpanel").resizable({handles:{e:fe("#egrip")},resize:function(e,t){t.size.height=t.originalSize.height},stop:function(e,t){q.updateSize()},cancel:""});var R={init:function(){this.select=new ve.interaction.Select({filter:function(e){return!!A[e.getId()]},style:function(e){var t=new ve.style.Fill({color:"rgba(255,255,255,0.4)"}),o=new ve.style.Stroke({color:"#3399CC",width:2});return[new ve.style.Style({image:new ve.style.Circle({fill:t,stroke:o,radius:5}),fill:t,stroke:o,text:new ve.style.Text({text:""+e.get("stageposition"),textAlign:"center",scale:1.3,fill:new ve.style.Fill({color:"#fff"}),stroke:new ve.style.Stroke({color:"#3399CC",width:3.5})}),zIndex:"Infinity"})]}}),q.addInteraction(this.select),this.modify=new ve.interaction.Modify({features:this.select.getFeatures(),style:new ve.style.Style({image:new ve.style.Circle({radius:5,fill:new ve.style.Fill({color:"#3399CC"}),stroke:new ve.style.Stroke({color:"#000000",width:2})})}),deleteCondition:function(e){return ve.events.condition.shiftKeyOnly(e)&&ve.events.condition.singleClick(e)}}),q.addInteraction(this.modify),this.setEvents()},setEvents:function(){P=this.select.getFeatures(),this.select.on("change:active",function(){P.clear(),U()}),this.select.on("select",function(){0<P.getLength()?fe("#removefeature").button("option","disabled",!1):U()}),this.modify.on("modifyend",function(e){var t,s,l,d;oe(),t=e.features,s=x,l=k,d=C.roads[w].vector,t.forEach(function(e){var t,o=e.get("stageid"),i=l.getFeatureById(o);i||((i=s.getFeatureById(o).clone()).setId(o),l.addFeature(i));for(var n=new ve.geom.MultiPolygon([]),a=0,r=(t=i.get("idFeaturesPolygons").split(",")).length;a<r;a++)n.appendPolygon(d.getSource().getFeatureById(t[a]).getGeometry().clone());i.setGeometry(n)}),I=!0})},getActive:function(){return!(!this.select.getActive()||!this.modify.getActive())},setActive:function(e){this.select.setActive(e),this.modify.setActive(e)}};R.init();var K={init:function(){q.addInteraction(this.Polygon),this.Polygon.setActive(!1),this.setEvents()},Polygon:new ve.interaction.Draw({source:M.getSource(),type:"Polygon",style:new ve.style.Style({fill:new ve.style.Fill({color:"rgba(0, 0, 0, 0.05)"}),stroke:new ve.style.Stroke({color:"#FAC30B",width:2}),image:new ve.style.Circle({radius:5,fill:new ve.style.Fill({color:"#ffcc33"}),stroke:new ve.style.Stroke({color:"#000000",width:2})}),zIndex:"Infinity"})}),setEvents:function(){this.Polygon.on("drawend",function(e){E=!1,S?(M.getSource().clear(),S=!1):(e.feature.setProperties({roadid:w,stageid:F,stageposition:b}),A[T]=!0,e.feature.setId(T),T++,C.roads[w].vector.getSource().addFeature(e.feature),function(e,t,o){var i=e.get("stageid"),n=e.get("roadid"),a=o.getFeatureById(i);a||((a=t.getFeatureById(i).clone()).setId(i),o.addFeature(a));"empty"===a.get("idFeaturesPolygons")?(a.setProperties({idFeaturesPolygons:""+e.getId()}),function(e,t){if(fe('#stagelist li[stageid="'+e+'"]').children(".handle, .nohandle").addClass("validstage").removeClass("invalidstage"),t){fe("label[for='addradio']").removeClass("highlightbutton"),0===fe("#stagelist li[roadid='"+t+"']").find(".invalidstage").length&&fe("#erremptystage").addClass("invisible")}}(i,n)):a.setProperties({idFeaturesPolygons:a.get("idFeaturesPolygons")+","+e.getId()});a.getGeometry().appendPolygon(e.getGeometry())}(e.feature,x,k),M.getSource().clear(),oe(),I=!0)}),this.Polygon.on("drawstart",function(e){E=!0})},getActive:function(){return this.Polygon.getActive()},setActive:function(e){e?this.Polygon.setActive(!0):this.Polygon.setActive(!1),q.getTargetElement().style.cursor=e?"none":""}};fe(document).keyup(function(e){27===e.keyCode&&E&&(S=!0,K.Polygon.finishDrawing())}),K.init(),K.setActive(!1),R.setActive(!1),te();var J,X=new ve.interaction.Snap({source:M.getSource()});function Y(e){var t=e.get("stageposition");return isNaN(t)||(L.getText().setText(""+t),z.getText().setText(""+t)),A[e.getId()]?[L]:[z]}function Z(e,t){var o=0;for(var i in e)if(C.roads.hasOwnProperty(i)){o=1,(e[w=i].blocked?ee:$)(),ae(w,e[w].vector,t);break}0===o&&(ee(),fe("#addroad").addClass("highlightbutton"),fe("#stagelistpanel").addClass("invisible"),t.updateSize())}function Q(e,t){fe('#stagelist li[stageid="'+e+'"]').children(".handle,.nohandle").addClass("invalidstage").removeClass("validstage"),t&&(fe("label[for='addradio']").addClass("highlightbutton"),2<=fe("#stagelist li[roadid='"+t+"']").length&&fe("#erremptystage").removeClass("invisible"))}function U(){fe("#removefeature").button("option","disabled",!0)}function $(){fe("#addstage").button("option","disabled",!1)}function ee(){fe("#addstage").button("option","disabled",!0)}function te(){fe("#edition").find("input:radio");fe("#edition").find("input:radio").prop("checked",!1).end().buttonset("refresh"),fe("#edition").buttonset("disable"),K.setActive(!1),R.setActive(!1)}function oe(){fe("#savestage").button("option","disabled",!1)}function ie(e,t,o){var i=e.getView();o?i.fit(o,{duration:700}):i.animate({zoom:19,center:t,duration:700})}function ne(e){0<e.length?fe("#stagelistpanel").removeClass("invisible"):fe("#stagelistpanel").addClass("invisible"),q.updateSize(),e.length<2?(fe("#addstage").addClass("highlightbutton"),fe("#errvalidroad").removeClass("invisible"),fe("#erremptystage").addClass("invisible")):0<e.find(".invalidstage").length?(fe("#addstage").removeClass("highlightbutton"),fe("#errvalidroad").addClass("invisible"),fe("#erremptystage").removeClass("invisible")):(fe("#addstage").removeClass("highlightbutton"),fe("#errvalidroad").addClass("invisible"),fe("#erremptystage").addClass("invisible"))}function ae(e,t,o){fe("#stagelist li").removeClass("ui-selected").hide();var i=fe("#stagelist li[roadid='"+e+"']");i.show(),ne(i),fe("#roadlist li[roadid='"+e+"']").addClass("ui-selected"),o.getLayers().forEach(function(e){e instanceof ve.layer.Vector&&e.setVisible(!1)}),t.setVisible(!0),0<t.getSource().getFeatures().length&&ie(o,null,t.getSource().getExtent())}function re(e,t){var o="editstage.php?cmid="+t+"&id="+e;window.location.href=o}function se(e,t){var o="editstage.php?cmid="+t+"&roadid="+e;window.location.href=o}function le(e,t){var o="editroad.php?cmid="+t+"&id="+e;window.location.href=o}function de(e){var t="editroad.php?cmid="+e;window.location.href=t}function ce(n,a,r,e,t){fe(".treasurehunt-editor-loader").show(),me.call([{methodname:"mod_treasurehunt_delete_road",args:{roadid:n,treasurehuntid:e,lockid:t}}])[0].done(function(e){if(fe(".treasurehunt-editor-loader").hide(),e.status.code)he.alert("Error",e.status.msg,"Continue");else{!function(e){var t=fe('#roadlist li[roadid="'+e+'"]');if(0<t.length){var o=fe('#stagelist li[roadid="'+e+'"]');t.remove(),o.remove()}}(n),q.removeLayer(C.roads[n].vector),delete C.roads[n],Z(C.roads,q),te();for(var t=r.getFeatures(),o=0;o<t.length;o++)if(n===t[o].get("roadid")){var i=a.getFeatureById(t[o].getId());i&&a.removeFeature(i),r.removeFeature(t[o])}}}).fail(function(e){fe(".treasurehunt-editor-loader").hide(),console.log(e),he.exception(e)})}function ue(r,s,l,d,e,t){fe(".treasurehunt-editor-loader").show(),me.call([{methodname:"mod_treasurehunt_delete_stage",args:{stageid:r,treasurehuntid:e,lockid:t}}])[0].done(function(e){if(fe(".treasurehunt-editor-loader").hide(),e.status.code)he.alert("Error",e.status.msg,"Continue");else{var t,o=!1,i=s.getFeatureById(r);if(!function(e,t,o,i){var n=fe('#stagelist li[stageid="'+e+'"]');if(0<n.length){var a=n.attr("roadid"),r=n.index('li[roadid="'+a+'"]');n.remove();var s=fe("#stagelist li[roadid='"+a+"']");ne(s);for(var l=s.length,d=0;d<=r-1;d++)G(s,l,d,t,o,i)}}(r,s,l,d),i?("empty"!==i.get("idFeaturesPolygons")&&(o=i.get("idFeaturesPolygons").split(",")),s.removeFeature(i)):("empty"!==(i=l.getFeatureById(r)).get("idFeaturesPolygons")&&(o=i.get("idFeaturesPolygons").split(",")),l.removeFeature(i)),o)for(var n=0,a=o.length;n<a;n++)t=d.getSource().getFeatureById(o[n]),d.getSource().removeFeature(t)}}).fail(function(e){fe(".treasurehunt-editor-loader").hide(),console.log(e),he.exception(e)})}function ge(o,i,e,n,a,t){fe(".treasurehunt-editor-loader").show();var r,s=new ve.format.GeoJSON,l=o.getFeatures(),d=[];l.forEach(function(e){(r=e.clone()).unset("idFeaturesPolygons"),r.unset("name"),r.unset("clue"),r.unset("treasurehuntid"),r.setId(e.getId()),d.push(r)});var c=s.writeFeaturesObject(d,{dataProjection:"EPSG:4326",featureProjection:p});me.call([{methodname:"mod_treasurehunt_update_stages",args:{stages:c,treasurehuntid:e,lockid:t}}])[0].done(function(e){var t;(fe(".treasurehunt-editor-loader").hide(),e.status.code)?he.alert("Error",e.status.msg,"Continue"):(o.forEachFeature(function(e){(t=i.getFeatureById(e.getId())).setProperties(e.getProperties()),t.setGeometry(e.getGeometry())}),o.clear(),fe("#savestage").button("option","disabled",!0),I=!1,"function"==typeof n&&a instanceof Array&&n.apply(null,a))}).fail(function(e){fe(".treasurehunt-editor-loader").hide(),console.log(e),he.alert("Error",e.message,"Continue")})}q.addInteraction(X),J=o,me.call([{methodname:"mod_treasurehunt_fetch_treasurehunt",args:{treasurehuntid:J}}])[0].done(function(e){if(fe(".treasurehunt-editor-loader").hide(),e.status.code)he.alert("Error",e.status.msg,"Continue");else{e.treasurehunt.stages;var g,t,o=new ve.format.GeoJSON,i=e.treasurehunt.roads;Array.isArray(i)||(i=Object.values(i)),i.forEach(function(u){u.blocked=1==u.blocked,function(e,t,o){if(fe('#roadlist li[roadid="'+e+'"]').length<1){fe('<li roadid="'+e+'" blocked="'+o+'"/>').appendTo(fe("#roadlist")).addClass("ui-corner-all").append("<div class='roadname'>"+t+"</div>").append("<div class='modifyroad'><span class='ui-icon ui-icon-trash'></span><span class='ui-icon ui-icon-pencil'></span></div>")}}(u.id,u.name,u.blocked),t=o.readFeatures(u.stages,{dataProjection:"EPSG:4326",featureProjection:p}),x.addFeatures(t),delete u.stages,g=new ve.layer.Vector({source:new ve.source.Vector({projection:p}),updateWhileAnimating:!0,style:Y}),t.forEach(function(e){null===e.getGeometry()&&e.setGeometry(new ve.geom.MultiPolygon([]));for(var t=e.getGeometry().getPolygons(),o="empty",i=e.get("stageposition"),n=e.get("name"),a=e.get("clue"),r=e.getId(),s=u.blocked,l=0;l<t.length;l++){var d=new ve.Feature(e.getProperties());d.setProperties({stageid:r});var c=t[l];d.setGeometry(c),d.setId(T),o=0===l?T:o+","+T,T++,g.getSource().addFeature(d)}e.setProperties({idFeaturesPolygons:""+o}),function(e,t,o,i,n,a){if(fe('#stagelist li[stageid="'+e+'"]').length<1){var r=fe('<li stageid="'+e+'" roadid="'+t+'" stageposition="'+o+'"/>').appendTo(fe("#stagelist"));r.addClass("ui-corner-all").append("<div class='stagename'>"+i+"</div>").append("<div class='modifystage'><span class='ui-icon ui-icon-pencil'></span><span class='ui-icon ui-icon-info' data-id='#dialoginfo"+e+"'><div id='dialoginfo"+e+"' title='"+i+"'>"+n+"</div></span></div>"),a?r.addClass("blocked").prepend("<div class='nohandle validstage'><span class='ui-icon ui-icon-locked'></span><span class='sortable-number'>"+o+"</span></div>"):(r.prepend("<div class='handle validstage'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><span class='sortable-number'>"+o+"</span></div>"),r.children(".modifystage").prepend("<span class='ui-icon ui-icon-trash'></span>")),fe("#dialoginfo"+e).dialog({maxHeight:500,autoOpen:!1})}else console.log("El li con "+e+" no ha podido crearse porque ya existia uno")}(r,u.id,i,n,a,s),0===t.length&&Q(r)}),u.vector=g,q.addLayer(g),C.roads[u.id]=u}),fe("#stagelist li").sort(function(e,t){var o=parseInt(fe(e).attr("stageposition")),i=parseInt(fe(t).attr("stageposition"));return o<i?1:i<o?-1:0}).appendTo(fe("#stagelist")),void 0!==C.roads[n]?(w=n,(C.roads[w].blocked?ee:$)(),ae(w,C.roads[w].vector,q)):Z(C.roads,q)}}).fail(function(e){fe(".treasurehunt-editor-loader").hide(),console.log(e),he.exception(e)}),fe(".searchaddress").autocomplete({minLength:4,source:function(e,s){var t=e.term;j.geocode(t,function(e){if(e[0]){for(var t=[],o=0,i=e.length;o<i;o++){var n,a;n=e[o].getLatitude(),a=e[o].getLongitude();var r={value:e[o].totalName,latitude:n,longitude:a,boundingbox:e[o].boundingbox};t[o]=r}s(t)}else s()})},select:function(e,t){if(t.item.boundingbox){var o=[];o[0]=parseFloat(t.item.boundingbox[2]),o[1]=parseFloat(t.item.boundingbox[0]),o[2]=parseFloat(t.item.boundingbox[3]),o[3]=parseFloat(t.item.boundingbox[1]),o=ve.proj.transformExtent(o,"EPSG:4326",p),ie(q,null,o)}else{var i=ve.proj.fromLonLat([t.item.longitude,t.item.latitude]);ie(q,i)}},autoFocus:!0}).on("click",function(){fe(this).autocomplete("search",fe(this).value)}),fe.ui.autocomplete.prototype._resizeMenu=function(){this.menu.element.outerWidth(this.element.outerWidth())},fe("#addstage").on("click",function(){I?ge(k,x,o,se,[w,t],a):se(w,t)}),fe("#addroad").on("click",function(){I?ge(k,x,o,de,[t],a):de(t)}),fe("#removefeature").on("click",function(){he.confirm(i.areyousure,i.removewarning,i.confirm,i.cancel,function(){var e,d,c,u,t,o;e=P,d=x,c=k,u=C.roads[w].vector,e.forEach(function(e){var t,o,i=e.get("stageid"),n=e.get("roadid"),a=c.getFeatureById(i);a||((a=d.getFeatureById(i).clone()).setId(i),c.addFeature(a));for(var r=new ve.geom.MultiPolygon([]),s=0,l=(t=a.get("idFeaturesPolygons").split(",")).length;s<l;s++)t[s]!=e.getId()?r.appendPolygon(u.getSource().getFeatureById(t[s]).getGeometry().clone()):o=s;a.setGeometry(r),r.getPolygons().length?(t.splice(o,1),a.setProperties({idFeaturesPolygons:t.join()})):(a.setProperties({idFeaturesPolygons:"empty"}),Q(i,n))}),t=P,o=C.roads[w].vector,t.forEach(function(e){o.getSource().removeFeature(e)}),t.clear(),U(),oe(),I=!0})}),fe("#savestage").on("click",function(){ge(k,x,o,null,null,a)}),fe("#stagelist").on("click",".ui-icon-info, .ui-icon-alert",function(){var e=fe(this).data("id");fe(e).dialog("open"),fe(".ui-dialog :button").blur()}),fe("#stagelist").on("click",".ui-icon-trash",function(){var e=fe(this).parents("li");he.confirm(i.areyousure,i.removewarning,i.confirm,i.cancel,function(){ue(parseInt(e.attr("stageid")),k,x,C.roads[w].vector,o,a)})}),fe("#stagelist").on("click",".ui-icon-pencil",function(){var e=parseInt(fe(this).parents("li").attr("stageid"));I?ge(k,x,o,re,[e,t],a):re(e,t)});var pe="off";fe("input[name=controlpanel]:radio").on("click",function(){var e=pe,t=fe(this).prop("id");t==e&&(fe("#edition").find("input:radio").buttonset().prop("checked",!1).end().buttonset("refresh"),t="off"),"addradio"===(pe=t)?(K.setActive(!0),R.setActive(!1)):"modifyradio"===t?(K.setActive(!1),R.setActive(!0)):(K.setActive(!1),R.setActive(!1))}),fe("#stagelist").on("click","li",function(e){fe(e.target).is(".handle ,.nohandle, .ui-icon , .sortable-number")?e.preventDefault():(fe(this).addClass("ui-selected").siblings().removeClass("ui-selected"),b=parseInt(fe(this).attr("stageposition")),F=parseInt(fe(this).attr("stageid")),function(e,t,o,i,n,a){t.getSource().clear(),i.clear(),A={};var r=n.getFeatureById(o);if(r=r||a.getFeatureById(o))if("empty"!==r.get("idFeaturesPolygons")){for(var s=r.get("idFeaturesPolygons").split(","),l=0,d=s.length;l<d;l++)t.getSource().addFeature(e.getSource().getFeatureById(s[l]).clone()),A[s[l]]=!0;t.getSource().getFeatures().length&&ie(q,null,t.getSource().getExtent())}else e.changed();else e.changed()}(C.roads[w].vector,B,F,P,k,x),fe("#edition").buttonset("enable"),0<fe(this).find(".invalidstage").length?fe("label[for='addradio']").addClass("highlightbutton"):fe("label[for='addradio']").removeClass("highlightbutton"),E&&(S=!0,K.Polygon.finishDrawing()))}),fe("#roadlist").on("click","li",function(e){if(fe(e.target).is(".ui-icon"))e.preventDefault();else{fe(this).addClass("ui-selected").siblings().removeClass("ui-selected"),A={},E&&(S=!0,K.Polygon.finishDrawing()),w=fe(this).attr("roadid");var t,o=fe(this).attr("blocked");(parseInt(o)||"true"===o?ee:$)(),ae(w,C.roads[w].vector,q),te(),t="fixed"===fe("header[role=banner]").css("position")?parseInt(fe(".treasurehunt-editor").offset().top)-parseInt(fe("header[role=banner]").outerHeight(!0)):parseInt(fe(".treasurehunt-editor").offset().top),fe("html, body").animate({scrollTop:t},500)}}),fe("#roadlist").on("click",".ui-icon-pencil",function(){var e=parseInt(fe(this).parents("li").attr("roadid"));I?ge(k,x,o,le,[e,t],a):le(e,t)}),fe("#roadlist").on("click",".ui-icon-trash",function(){var e=fe(this).parents("li");he.confirm(i.areyousure,i.removeroadwarning,i.confirm,i.cancel,function(){ce(parseInt(e.attr("roadid")),k,x,o,a)})}),q.on("pointermove",function(e){if(!e.dragging&&!K.getActive()&&R.getActive()){var t=q.getEventPixel(e.originalEvent),o=q.forEachFeatureAtPixel(t,function(t,e){if(A[t.getId()]){var o=!1;return P.forEach(function(e){t===e&&(o=!0)}),!o}return!1});q.getTargetElement().style.cursor=o?"pointer":""}}),fe(document).on("touchend",".ui-dialog-titlebar-close",function(){fe(this).parent().siblings(".ui-dialog-content").dialog("close")}),fe(".searchaddress").on("input",function(){fe(".closeicon")[this.value?"removeClass":"addClass"]("invisible")}),fe(".closeicon").on("touchstart click",function(e){e.preventDefault(),fe(this).addClass("invisible"),fe(".searchaddress").val("").change().autocomplete("close")}),window.onbeforeunload=function(e){var t=i.savewarning;e=e||window.event;if(I)return e&&(e.returnValue=t),t}}return{edittreasurehunt:function(n,a,r,s,l){var d=["stage","road","aerialmap","roadmap","basemaps","add","modify","save","remove","searchlocation","savewarning","removewarning","areyousure","removeroadwarning","confirm","cancel"],e=d.map(function(e){return{key:e,component:"treasurehunt"}});i.get_strings(e).done(function(e){for(var t=[],o=0;o<d.length;o++)t[d[o]]=e[o];if(null!=l&&null!==l.custombackgroundurl){var i=new Image;i.addEventListener("load",function(){l.imgwidth=this.naturalWidth,l.imgheight=this.naturalHeight,c(n,a,t,r,s,l)}),i.src=l.custombackgroundurl}else c(n,a,t,r,s,l)})}}});