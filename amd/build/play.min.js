define(["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/viewgpx","core/str","mod_treasurehunt/jquery.truncate","mod_treasurehunt/jquery.mobile-config","mod_treasurehunt/jquerymobile"],function(Ae,ze,Re,De,Le,Qe,t){return console.log("loading play.js"),{playtreasurehunt:function(a,i,l,s,r,c,u,p,d,g){var m=["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error"];console.log("loading i18n strings");var e=m.map(function(e){return{key:e,component:"treasurehunt"}});t.get_strings(e).done(function(e){for(var t=[],o=0;o<m.length;o++)t[m[o]]=e[o];if(null!=g&&null!==g.custombackgroundurl){console.log("detecting custom background image dimensions.");var n=new Image;n.addEventListener("load",function(){g.imgwidth=this.naturalWidth,g.imgheight=this.naturalHeight,console.log("image is "+this.naturalWidth+"x"+this.naturalHeight+"pixels"),f(t,a,i,l,s,r,c,u,p,d,g)}),n.src=g.custombackgroundurl}else f(t,a,i,l,s,r,c,u,p,d,g)})}};function f(r,c,u,p,d,g,m,e,f,t,o){console.log("init player Openlayers");var n="EPSG:3857",a=null,i=!0,l=19;if(null!=o){if(null!=o.custombackgroundurl){console.log("config custom background image");var s=Re.proj.transformExtent(o.bbox,"EPSG:4326",n);if(!o.geographic){s[2],s[0];var h=s[3]-s[1],w=(s[2]+s[0])/2,y=(s[3]+s[1])/2,v=Math.round(h/o.imgheight),b=Math.round(o.imgwidth*v),x=Math.round(o.imgheight*v);s=[w-b/2,y-x/2,w+b/2,y+x/2],l=5}a=new Re.layer.Image({title:o.layername,name:o.layername,type:o.layertype,source:new Re.source.ImageStatic({url:o.custombackgroundurl,imageExtent:s}),opacity:1})}else if(null!==o.wmsurl){console.log("config custom wms server: "+o.wmsurl);var k={source:new Re.source.TileWMS({url:o.wmsurl,params:o.wmsparams}),type:o.layertype,title:o.layername,name:o.layername};if(null!==o.bbox[0]&&null!==o.bbox[1]&&null!==o.bbox[2]&&null!==o.bbox[3]){var S=Re.proj.transformExtent(o.bbox,"EPSG:4326",n);k.extent=S}a=new Re.layer.Tile(k)}i=o.geographic}!1===i&&(console.log("geographic tools disabled"),p=!0,Ae("#autolocate").hide());var T,P=ze.imageUrl("success_mark","treasurehunt"),E=ze.imageUrl("failure_mark","treasurehunt"),q=ze.imageUrl("my_location","treasurehunt"),G=Le.createGeocoder("openstreetmap"),I={},_=0,C=0,F=[],j=[],V=!1,A=!1,z=!1,R=!1,D=!1,L=!0,Q=!1,M=new Re.style.Text({textAlign:"center",scale:1.3,fill:new Re.style.Fill({color:"#fff"}),stroke:new Re.style.Stroke({color:"#000",width:3.5})}),O=new Re.style.Text({textAlign:"center",scale:1.4,fill:new Re.style.Fill({color:"#fff"}),stroke:new Re.style.Stroke({color:"#3399CC",width:3.5})}),N=new Re.style.Style({image:new Re.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:P}),text:M,zIndex:"Infinity"}),W=new Re.style.Style({image:new Re.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:E}),text:M,zIndex:"Infinity"}),H=new Re.style.Style({image:new Re.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:P}),text:O,zIndex:"Infinity"}),B=new Re.style.Style({image:new Re.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:E}),text:O,zIndex:"Infinity"}),U=new Re.style.Style({image:new Re.style.Circle({radius:6,fill:new Re.style.Fill({color:[0,0,0,1]}),stroke:new Re.style.Stroke({color:[255,255,255,1],width:2})})}),Z=new Re.style.Style({fill:new Re.style.Fill({color:[255,255,255,.3]}),stroke:new Re.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),K=new Re.style.Style({image:new Re.style.Icon({anchor:[.5,1],opacity:1,scale:.35,src:q})}),X=[],Y=new Re.format.GeoJSON,J=new Re.source.Vector({projection:"EPSG:3857"}),$=new Re.layer.Vector({source:J,style:function(e,t){var o=e.get("stageposition");if(0!==o)return e.get("geometrysolved")?(N.getText().setText(""+o),[N]):(W.getText().setText(""+o),[W]);var n=new Re.style.Fill({color:"rgba(255,255,255,0.4)"}),a=new Re.style.Stroke({color:"#3399CC",width:1.25});return[new Re.style.Style({image:new Re.style.Circle({fill:n,stroke:a,radius:5}),fill:n,stroke:a,text:new Re.style.Text({text:r.startfromhere,textAlign:"center",fill:new Re.style.Fill({color:"rgb(255,255,255)"}),stroke:new Re.style.Stroke({color:"#3399CC",width:5})})})]}}),ee=new Re.layer.Tile({visible:!1,source:new Re.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});ee.set("name",r.aerialview);var te=new Re.layer.Tile({source:new Re.source.OSM});te.set("name",r.roadview);var oe=[],ne=[];null!==o&&!1!==o.onlybase||(oe=[ee,te]),null!==a&&("overlay"!=o.layertype?oe.push(a):ne.push(a));var ae=new Re.layer.Group({layers:oe}),ie=null;ae.getLayers().forEach(function(e){e.setVisible(!1),ie=e}),ie.setVisible(!0);var le=new Re.View({center:[0,0],zoom:2,minZoom:2}),se=new Re.interaction.Select({layers:[$],style:function(e,t){var o=e.get("stageposition");return e.get("geometrysolved")?(H.getText().setText(""+o),[H]):(B.getText().setText(""+o),[B])},filter:function(e,t){return 0!==e.get("stageposition")}}),re=new Re.Feature;re.setProperties({name:"user_accuracy"}),re.setStyle(Z);var ce=new Re.Feature;ce.setProperties({name:"user_position"}),ce.setStyle(U);var ue=new Re.layer.Vector({source:new Re.source.Vector({features:[re,ce]})}),pe=new Re.Feature;pe.setGeometry(null),pe.setStyle(K);var de=new Re.layer.Vector({source:new Re.source.Vector({features:[pe]})});X.push(ae),X=(X=X.concat(ne)).concat([$,ue,de]);var ge,me=new Re.control.Zoom({target:"navigation",className:"custom-zoom"}),fe=new Re.Map({layers:X,controls:[me],target:"mapplay",view:le,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});if(fe.addInteraction(se),xe(!1,!0),T=setInterval(function(){xe(!1,!1)},e),(ge=ae).getLayers().forEach(function(t){var e=Ae("<li>",{"data-icon":"check",class:t.getVisible()?"checked":"unchecked"}).append(Ae("<a />",{text:t.get("name"),href:"#mappage"}).click(function(){ge.getLayers().forEach(function(e){e===t?e.setVisible(!0):e.setVisible(!1)})}));t.on("change:visible",function(){Ae(e).toggleClass("checked unchecked")}),e.insertAfter("#baseLayer")}),ne.forEach(function(e){Ee(e)}),f&&t){var he=Qe.addgpxlayer(fe,c,u,r,t,"trackgroup");he.set("name",he.get("title"));var we=he.getLayers().item(0),ye=we.get("title"),ve=ye.substring(ye.indexOf("</a>")+4);we.set("name",ve),we.setVisible(!1),Ee(we)}function be(e,t,o){var n=e.getView();o?n.fit(o,{duration:700}):n.animate({zoom:l,center:t,duration:700})}function xe(n,a,i,e){var t,o,l,s;(l=p?pe.getGeometry():ce.getGeometry())&&(o=Y.writeGeometryObject(l,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),i&&(Ae.mobile.loading("show"),s=i),n&&(t=o,Ae.mobile.loading("show")),De.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:u,attempttimestamp:g,roadtimestamp:m,playwithoutmoving:p,groupmode:d,initialize:a,location:t,currentposition:f&&!p?o:void 0,selectedanswerid:s,qoaremoved:Q,qrtext:e}}}])[0].done(function(e){var t="";if(Q=e.qoaremoved,D=e.roadfinished,L=e.available,(n||i)&&(Ae.mobile.loading("hide"),null!==e.status&&L&&console.log(e.status.msg)),e.qrexpected?Ae("#validateqr").show():Ae("#validateqr").hide(),p!=e.playwithoutmoving&&((p=e.playwithoutmoving)||pe.setGeometry(null)),d!=e.groupmode&&(d=e.groupmode),g!==e.attempttimestamp||m!==e.roadtimestamp||a||!L){g=e.attempttimestamp,m=e.roadtimestamp,0<e.historicalattempts.length&&(j=e.historicalattempts,V=!0),(e.attempts||e.firststagegeom)&&(J.clear(),e.firststagegeom&&J.addFeatures(Y.readFeatures(e.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),0<e.attempts.features.length&&J.addFeatures(Y.readFeatures(e.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))),e.lastsuccessfulstage&&(I=e.lastsuccessfulstage,A=!0,""!==I.question?(z=!0,Ae("#validatelocation").hide(),Ae("#question_button").show()):I.activitysolved?(Ae("#validatelocation").show(),Ae("#question_button").hide()):(Ae("#validatelocation").hide(),Ae("#question_button").show())),(e.firststagegeom||a)&&(R=!0);var o=Ae.mobile.pageContainer.pagecontainer("getActivePage").prop("id");"mappage"===o?(Se(),ke()):"historypage"===o?Pe():"questionpage"===o&&(""===I.question?Ae.mobile.pageContainer.pagecontainer("change","#mappage"):(Te(),Ae.mobile.resetActivePageHeight()))}0<e.infomsg.length&&(F.forEach(function(e){t+="<p>"+e+"</p>"}),e.infomsg.forEach(function(e){F.push(e),t+="<p>"+e+"</p>"}),Fe("displayupdates",r.updates,t)),D||Ae("#roadended").hide(),!D&&L||(Ae("#validatelocation").hide(),Ae("#question_button").hide(),Ae("#roadended").show(),pe.setGeometry(null),p=!1,clearInterval(T),Ae("#mapplay").css("opacity","0.8"))}).fail(function(e){console.log(e),Fe("displayerror",r.error,e.message),clearInterval(T)})}function ke(){if(R){var e=J.getFeatures();1===e.length&&e[0].getGeometry()instanceof Re.geom.Point?be(fe,e[0].getGeometry().getCoordinates()):be(fe,null,J.getExtent()),R=!1}}function Se(){if(A){Ae("#lastsuccessfulstagename").text(r.stage+":"+I.name),Ae("#lastsuccesfulstagepos").text(I.position+" / "+I.totalnumber);var e;I.clue=I.clue.replace(/color/gm,"color-disabled"),Ae("#lastsuccessfulstageclue").html(I.clue),200<I.clue.replace(/<(?:.|\n)*?>/gm,"").length?(Ae("#lastsuccessfulstageclue").truncate(200),e=' <a href="#historypage" data-transition="none" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-icon-info ui-btn-icon-notext"></a> ',Ae("#lastsuccessfulstageclue").append(e)):e=I.clue,Ae("#lastsuccessfulstagename2").text(I.name),Ae("#lastsuccesfulstagepos2").text(I.position+" / "+I.totalnumber),Ae("#lastsuccessfulstageclue2").html(I.clue),""!==I.question&&(Ae("#lastsuccessfulstageclue").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+r.question+"</a>"),Ae("#lastsuccessfulstageclue2").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+r.question+"</a>")),Ae("#collapsibleset").collapsibleset("refresh"),Ae("#infopanel").panel("open"),Ae("#lastsuccessfulstage").collapsible("expand"),A=!1}}function Te(){if(z){I.question=I.question.replace(/color/gm,"color-disabled"),Ae("#questionform").html("<legend>"+I.question+"</legend>");var n=1;Ae.each(I.answers,function(e,t){var o="answer"+n;t.answertext=t.answertext.replace(/color/gm,"color-disabled"),Ae("#questionform").append('<input type="radio" name="answers" id="'+o+'"value="'+t.id+'"><label for="'+o+'">'+t.answertext+"</label>"),n++}),z=!1}}function Pe(){if(V){var t=Ae("#historylist");t.html(""),V=!1,0===j.length?Ae("<li>"+r.noattempts+"</li>").appendTo(t):j.forEach(function(e){Ae("<li><span class='ui-btn-icon-left "+(e.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+e.string+"</li>").appendTo(t)}),t.listview("refresh"),t.trigger("updatelayout")}}function Ee(e){var t=Ae("<li>",{"data-icon":"check",class:e.getVisible()?"checked":"unchecked"}).append(Ae("<a />",{text:e.get("name"),href:"#mappage"}).click(function(){e.setVisible(!e.getVisible())}));e.on("change:visible",function(){Ae(t).toggleClass("checked unchecked")}),t.insertAfter("#baseLayer")}var qe=new Re.Geolocation({projection:le.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});qe.on("change:position",function(){var e=this.getPosition();ce.setGeometry(e?new Re.geom.Point(e):null),this.get("center")&&(be(fe,e),this.setProperties({center:!1})),this.get("validate_location")&&(xe(!0,!1),this.setProperties({validate_location:!1})),Ae.mobile.loading("hide")}),qe.on("change:accuracyGeometry",function(){re.setGeometry(this.getAccuracyGeometry()),Ae.mobile.loading("hide")});var Ge=!1;qe.on("error",function(e){Ae.mobile.loading("hide"),qe.setProperties({user_denied:!0}),Ce(e.message),e.code==e.PERMISSION_DENIED&&f&&!p&&0==Ge&&setTimeout(function(){Ae("#popupgeoloc").popup("open",{positionTo:"window"}),Ge=!0},500)}),qe.setTracking(f),se.on("select",function(e){if(1===e.selected.length)if(I.position===e.selected[0].get("stageposition")&&e.selected[0].get("geometrysolved")&&!D&&L)Ae("#infopanel").panel("open"),Ae("#lastsuccessfulstage").collapsible("expand");else{var t,o=e.selected[0].get("name"),n=e.selected[0].get("clue"),a=e.selected[0].get("info"),i="";e.selected[0].get("geometrysolved")?o&&n?(t=r.stageovercome,i=Ve(r.stagename,o),i+=Ve(r.stageclue,n)):t=r.discoveredlocation:t=r.failedlocation,a&&(i+="<p>"+a+"</p>"),Fe("infostage",t,i)}}),fe.on("click",function(e){var o=!1;if(fe.forEachFeatureAtPixel(fe.getEventPixel(e.originalEvent),function(e,t){if(0===e.get("stageposition")||"user_position"===e.get("name")||"user_accuracy"===e.get("name"))return!1;o=!0}),p&&!o){var t=fe.getEventCoordinate(e.originalEvent);pe.setGeometry(t?new Re.geom.Point(t):null)}}),Ae("#autocomplete").on("filterablebeforefilter",function(e,t){if(i){var o=Ae(this),n=Ae(t.input).val();o.html(""),n&&2<n.length&&(Ae.mobile.loading("show",{text:r.searching,textVisible:!0,theme:"b"}),G.geocode(n,function(e){!1===e[0]?o.html("<li data-filtertext='"+n+"'>"+r.noresults+"</li>"):Ae.each(e,function(e,t){Ae("<li data-filtertext='"+n+"'>").hide().append(Ae("<a href='#'>").text(t.totalName).append(Ae("<p>").text(t.type))).appendTo(o).click(function(){var e=[];e[0]=parseFloat(t.boundingbox[2]),e[1]=parseFloat(t.boundingbox[0]),e[2]=parseFloat(t.boundingbox[3]),e[3]=parseFloat(t.boundingbox[1]),e=Re.proj.transformExtent(e,"EPSG:4326","EPSG:3857"),be(fe,null,e),Ae("#searchpanel").panel("close")}).show()}),o.listview("refresh"),o.trigger("updatelayout"),Ae.mobile.loading("hide")}))}}),Ae("#infopanel").on("collapsibleexpand","[data-role='collapsible']",function(e,t){var o=Ae("#infopanel .ui-panel-inner");o.animate({scrollTop:parseInt(Ae(this).offset().top-o.offset().top+o.scrollTop())},500)}),Ae(document).on("popupbeforeposition",function(){var e=Ae(window).height()-200+"px";Ae('.ui-popup [data-role="content"]').css("max-height",e)}),Ae(document).on("popupafterclose",".ui-popup:not(#QRdialog):not(#popupdialog):not(#popupgeoloc)",function(){Ae(this).remove(),se.getFeatures().clear()}),Ae(document).on("click","#acceptupdates",function(){F=[]}),Ae(window).on("pagecontainershow resize",function(e,t){Ae.mobile.resetActivePageHeight();var o=Ae.mobile.pageContainer.pagecontainer("getActivePage").prop("id");"mappage"===o?"resize"===e.type?setTimeout(function(){fe.updateSize()},200):(fe.updateSize(),Se(),ke()):"historypage"===o?"pagecontainershow"===e.type&&Pe():"questionpage"===o&&"pagecontainershow"===e.type&&(""===I.question?Ae.mobile.pageContainer.pagecontainer("change","#mappage"):Te())}),i&&Ae("#autolocate").on("click",function(){qe.get("user_denied")?Ae("#popupgeoloc").popup("open",{positionTo:"window"}):(position=qe.getPosition(),be(fe,position))}),Ae("#infopanel").panel({beforeclose:function(){se.getFeatures().clear()}}),Ae("#sendLocation").on("click",function(){p&&null===pe.getGeometry()?Ce(r.nomarks):xe(!0,!1)}),Ae("#sendAnswer").on("click",function(e){var t=Ae("#questionform input[type='radio']:checked");L?0===t.length?(e.preventDefault(),Ce(r.noanswerselected)):xe(!1,!1,t.val()):(e.preventDefault(),Ce(r.timeexceeded))}),Ae("#validatelocation").on("click",function(e){return D?(e.preventDefault(),void Ce(r.huntcompleted)):L?""!==I.question?(e.preventDefault(),Ce(r.answerwarning),void Ae("#infopanel").panel("open")):I.activitysolved?void 0:(e.preventDefault(),Ce(r.activitytoendwarning),void Ae("#infopanel").panel("open")):(e.preventDefault(),void Ce(r.timeexceeded))}),!1===Ae.mobile.autoInitializePage&&(Ae("#container").show(),Ae("#loader").remove(),Ae.mobile.initializePage(),document.querySelector("meta[name=viewport]").setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"),Ae("#QRdialog").popup({beforeposition:function(e,t){Ae(this).width(.9*window.innerWidth),Ae(this).height(.9*window.innerHeight)},afteropen:function(e,t){var o=Ae(this).find("div[data-role='content']").first(),n=Ae(this).find("div[data-role='header']").first(),a=parseInt(o.css("padding-top"))+parseInt(o.css("padding-bottom"));o.css("max-height","1000px"),Ae("#previewVideoDiv").width(Ae(this).width()-a).height(Ae(this).height()-Ae("#previewQRbuttons").height()-n.height()-2*a),Ae("#previewQRvideo").show(),loadQR(Ie,_e)},afterclose:function(e,t){unloadQR(_e)}}));function Ie(e){Ae("#QRdialog").popup("close"),console.log(e),Ce("QR code readed: "+e),xe(!1,!1,null,e)}function _e(e){"string"==typeof e?Ae("#errorQR").text(e):(null!==e.cameras[e.camera].name&&Ae("#errorQR").text(e.cameras[e.camera].name),1<e.cameras.length?Ae("#nextcamera").show():Ae("#nextcamera").hide())}function Ce(e){0<Ae(".toast").length?setTimeout(function(){Ce(e)},2500):Ae("<div class='ui-loader ui-overlay-shadow  ui-corner-all toast'><p>"+e+"</p></div>").css({left:(Ae(window).width()-284)/2,top:Ae(window).height()/2}).appendTo(Ae.mobile.pageContainer).delay(2e3).fadeOut(400,function(){Ae(this).remove()})}function Fe(e,t,o){var n=Ae('<div data-role="header"><h2>'+t+"</h2></div>"),a=Ae('<div data-role="content" class="ui-content ui-overlay-b">'+o+"</div>"),i=Ae('<div data-role="popup" id="'+e+'"data-theme="b" data-transition="slidedown"></div>');if("infostage"===e&&Ae('<a href="#" data-rel="back" class="ui-btn ui-corner-allui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right"></a>').appendTo(n),"displayupdates"===e){Ae('<p class="center-wrapper"><a id="acceptupdates" href="#" data-rel="back"class="ui-btn center-button ui-mini ui-btn-inline">'+r.continue+"</a></p>").appendTo(a);var l={"data-dismissible":!1,"data-overlay-theme":"b"};Ae(i).attr(l)}if("displayerror"===e){Ae('<p class="center-wrapper"><a href="view.php?id='+c+'" class="ui-btn  center-button ui-mini ui-icon-forward ui-btn-inline ui-btn-icon-left"data-ajax="false">'+r.continue+"</a></p>").appendTo(a);l={"data-dismissible":!1,"data-overlay-theme":"b"};Ae(i).attr(l)}if(Ae(n).appendTo(Ae(i).appendTo(Ae.mobile.activePage).popup()).toolbar().after(a),0<(C=Ae(a).find("img")).length){Ae.mobile.loading("show"),C.one("load",function(){_++,C.length===_&&(je(i),_=0,clearTimeout(s),Ae.mobile.loading("hide"))});var s=setTimeout(function(){je(i),Ae.mobile.loading("hide")},2e3)}else je(i)}function je(e){0<Ae(".ui-popup-active").length?(Ae(".ui-popup").popup("close"),setTimeout(function(){Ae(e).popup("open",{positionTo:"window"})},1e3)):Ae(e).popup("open",{positionTo:"window"})}function Ve(e,t){return'<div class="ui-bar ui-bar-a">'+e+'</div><div class="ui-body ui-body-a">'+t+"</div>"}Ae("#nextcamera").on("click",function(){if(null!==detectedCameras){var e=getnextwebCam();Ce("Give access to:"+detectedCameras[e].name)}setnextwebcam(_e)})}});