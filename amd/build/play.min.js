define(["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/viewgpx","core/str","mod_treasurehunt/jquery.truncate","mod_treasurehunt/jquery.mobile-config","mod_treasurehunt/jquerymobile"],function(a,b,c,d,e,f,g){function h(g,h,i,j,k,l,m,n,o,p,q){function r(a,b){var d=a.get("stageposition");if(0===d){var e=new c.style.Fill({color:"rgba(255,255,255,0.4)"}),f=new c.style.Stroke({color:"#3399CC",width:1.25}),h=new c.style.Style({image:new c.style.Circle({fill:e,stroke:f,radius:5}),fill:e,stroke:f,text:new c.style.Text({text:g.startfromhere,textAlign:"center",fill:new c.style.Fill({color:"rgb(255,255,255)"}),stroke:new c.style.Stroke({color:"#3399CC",width:5})})});return[h]}return a.get("geometrysolved")?(oa.getText().setText(""+d),[oa]):(pa.getText().setText(""+d),[pa])}function s(a,b){var c=a.get("stageposition");return a.get("geometrysolved")?(qa.getText().setText(""+c),[qa]):(ra.getText().setText(""+c),[ra])}function t(){j&&null===Ka.getGeometry()?F(g.nomarks):w(!0,!1)}function u(){position=Sa.getPosition(),v(Na,position)}function v(a,b,c){var d=700,e=a.getView();c?e.fit(c,{duration:d}):e.animate({zoom:N,center:b,duration:d})}function w(b,c,e,f){var h,n,p,q;p=j?Ka.getGeometry():Ia.getGeometry(),p&&(n=wa.writeGeometryObject(p,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),e&&(a.mobile.loading("show"),q=e),b&&(h=n,a.mobile.loading("show"));var r=d.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:i,attempttimestamp:l,roadtimestamp:m,playwithoutmoving:j,groupmode:k,initialize:c,location:h,currentposition:o&&!j?n:void 0,selectedanswerid:q,qoaremoved:la,qrtext:f}}}]);r[0].done(function(d){var f="";if(la=d.qoaremoved,ja=d.roadfinished,ka=d.available,(b||e)&&(a.mobile.loading("hide"),null!==d.status&&ka&&F(d.status.msg)),d.qrexpected?a("#validateqr").show():a("#validateqr").hide(),j!=d.playwithoutmoving&&(j=d.playwithoutmoving,j||Ka.setGeometry(null)),k!=d.groupmode&&(k=d.groupmode),l!==d.attempttimestamp||m!==d.roadtimestamp||c||!ka){l=d.attempttimestamp,m=d.roadtimestamp,d.historicalattempts.length>0&&(ea=d.historicalattempts,fa=!0),(d.attempts||d.firststagegeom)&&(xa.clear(),d.firststagegeom&&xa.addFeatures(wa.readFeatures(d.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),d.attempts.features.length>0&&xa.addFeatures(wa.readFeatures(d.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))),d.lastsuccessfulstage&&(aa=d.lastsuccessfulstage,ga=!0,""!==aa.question?(ha=!0,a("#validatelocation").hide(),a("#question_button").show()):aa.activitysolved?(a("#validatelocation").show(),a("#question_button").hide()):(a("#validatelocation").hide(),a("#question_button").show())),(d.firststagegeom||c)&&(ia=!0);var h=a.mobile.pageContainer.pagecontainer("getActivePage").prop("id");"mappage"===h?(y(),x()):"historypage"===h?A():"questionpage"===h&&(""===aa.question?a.mobile.pageContainer.pagecontainer("change","#mappage"):(z(),a.mobile.resetActivePageHeight()))}d.infomsg.length>0&&(da.forEach(function(a){f+="<p>"+a+"</p>"}),d.infomsg.forEach(function(a){da.push(a),f+="<p>"+a+"</p>"}),G("displayupdates",g.updates,f)),ja||a("#roadended").hide(),!ja&&ka||(a("#validatelocation").hide(),a("#question_button").hide(),a("#roadended").show(),Ka.setGeometry(null),j=!1,clearInterval(X),a("#mapplay").css("opacity","0.8"))}).fail(function(a){console.log(a),G("displayerror",g.error,a.message),clearInterval(X)})}function x(){if(ia){var a=xa.getFeatures();1===a.length&&a[0].getGeometry()instanceof c.geom.Point?v(Na,a[0].getGeometry().getCoordinates()):v(Na,null,xa.getExtent()),ia=!1}}function y(){if(ga){a("#lastsuccessfulstagename").text(g.stage+":"+aa.name),a("#lastsuccesfulstagepos").text(aa.position+" / "+aa.totalnumber);var b,c=100;aa.clue=aa.clue.replace(/color/gm,"color-disabled"),a("#lastsuccessfulstageclue").html(aa.clue);var d=aa.clue.replace(/<(?:.|\n)*?>/gm,"");d.length>2*c?(a("#lastsuccessfulstageclue").truncate(2*c),b=' <a href="#historypage" data-transition="none" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-icon-info ui-btn-icon-notext"></a> ',a("#lastsuccessfulstageclue").append(b)):b=aa.clue,a("#lastsuccessfulstagename2").text(aa.name),a("#lastsuccesfulstagepos2").text(aa.position+" / "+aa.totalnumber),a("#lastsuccessfulstageclue2").html(aa.clue),""!==aa.question&&(a("#lastsuccessfulstageclue").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+g.question+"</a>"),a("#lastsuccessfulstageclue2").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+g.question+"</a>")),a("#collapsibleset").collapsibleset("refresh"),a("#infopanel").panel("open"),a("#lastsuccessfulstage").collapsible("expand"),ga=!1}}function z(){if(ha){aa.question=aa.question.replace(/color/gm,"color-disabled"),a("#questionform").html("<legend>"+aa.question+"</legend>");var b=1;a.each(aa.answers,function(c,d){var e="answer"+b;d.answertext=d.answertext.replace(/color/gm,"color-disabled"),a("#questionform").append('<input type="radio" name="answers" id="'+e+'"value="'+d.id+'"><label for="'+e+'">'+d.answertext+"</label>"),b++}),a("#questionform").enhanceWithin().controlgroup("refresh"),ha=!1}}function A(){if(fa){var b=a("#historylist");b.html(""),fa=!1,0===ea.length?a("<li>"+g.noattempts+"</li>").appendTo(b):ea.forEach(function(c){a("<li><span class='ui-btn-icon-left "+(c.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+c.string+"</li>").appendTo(b)}),b.listview("refresh"),b.trigger("updatelayout")}}function B(b){var c=a("<li>",{"data-icon":"check",class:b.getVisible()?"checked":"unchecked"}).append(a("<a />",{text:b.get("name"),href:"#mappage"}).click(function(){b.setVisible(!b.getVisible())}));b.on("change:visible",function(){a(c).toggleClass("checked unchecked")}),c.insertAfter("#baseLayer")}function C(b){b.getLayers().forEach(function(c){var d=a("<li>",{"data-icon":"check",class:c.getVisible()?"checked":"unchecked"}).append(a("<a />",{text:c.get("name"),href:"#mappage"}).click(function(){b.getLayers().forEach(function(a){a===c?a.setVisible(!0):a.setVisible(!1)})}));c.on("change:visible",function(){a(d).toggleClass("checked unchecked")}),d.insertAfter("#baseLayer")})}function D(b){I(a("#QRdialog")),console.log(b),F("QR code readed: "+b),w(!1,!1,null,b)}function E(b){"string"==typeof b?a("#errorQR").text(b):(null!==b.cameras[b.camera].name&&a("#errorQR").text(b.cameras[b.camera].name),b.cameras.length>1?a("#nextcamera").show():a("#nextcamera").hide())}function F(b){a(".toast").length>0?setTimeout(function(){F(b)},2500):a("<div class='ui-loader ui-overlay-shadow  ui-corner-all toast'><p>"+b+"</p></div>").css({left:(a(window).width()-284)/2,top:a(window).height()/2}).appendTo(a.mobile.pageContainer).delay(2e3).fadeOut(400,function(){a(this).remove()})}function G(b,c,d){var e=a('<div data-role="header"><h2>'+c+"</h2></div>"),f=a('<div data-role="content" class="ui-content ui-overlay-b">'+d+"</div>"),i=a('<div data-role="popup" id="'+b+'"data-theme="b" data-transition="slidedown"></div>');if("infostage"===b&&a('<a href="#" data-rel="back" class="ui-btn ui-corner-allui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right"></a>').appendTo(e),"displayupdates"===b){a('<p class="center-wrapper"><a id="acceptupdates" href="#" data-rel="back"class="ui-btn center-button ui-mini ui-btn-inline">'+g.continue+"</a></p>").appendTo(f);var j={"data-dismissible":!1,"data-overlay-theme":"b"};a(i).attr(j)}if("displayerror"===b){a('<p class="center-wrapper"><a href="view.php?id='+h+'" class="ui-btn  center-button ui-mini ui-icon-forward ui-btn-inline ui-btn-icon-left"data-ajax="false">'+g.continue+"</a></p>").appendTo(f);var j={"data-dismissible":!1,"data-overlay-theme":"b"};a(i).attr(j)}if(a(e).appendTo(a(i).appendTo(a.mobile.activePage).popup()).toolbar().after(f),ca=a(f).find("img"),ca.length>0){a.mobile.loading("show"),ca.one("load",function(){ba++,ca.length===ba&&(H(i),ba=0,clearTimeout(k),a.mobile.loading("hide"))});var k=setTimeout(function(){H(i),a.mobile.loading("hide")},2e3)}else H(i)}function H(b){a(".ui-popup-active").length>0?(a(".ui-popup").popup("close"),setTimeout(function(){a(b).popup("open",{positionTo:"window"})},1e3)):a(b).popup("open",{positionTo:"window"})}function I(a){a.popup("close")}function J(a,b){return'<div class="ui-bar ui-bar-a">'+a+'</div><div class="ui-body ui-body-a">'+b+"</div>"}console.log("init player Openlayers");var K="EPSG:3857",L=null,M=!0,N=19;if("undefined"!=typeof q&&null!==q){if(null!=q.custombackgroundurl){console.log("config custom background image");var O=c.proj.transformExtent(q.bbox,"EPSG:4326",K);if(!q.geographic){var P=(O[2]-O[0],O[3]-O[1]),Q=(O[2]+O[0])/2,R=(O[3]+O[1])/2,S=Math.round(P/q.imgheight),T=Math.round(q.imgwidth*S),U=Math.round(q.imgheight*S);O=[Q-T/2,R-U/2,Q+T/2,R+U/2],N=5}L=new c.layer.Image({title:q.layername,name:q.layername,type:q.layertype,source:new c.source.ImageStatic({url:q.custombackgroundurl,imageExtent:O}),opacity:1})}else if(null!==q.wmsurl){console.log("config custom wms server: "+q.wmsurl);var V={source:new c.source.TileWMS({url:q.wmsurl,params:q.wmsparams}),type:q.layertype,title:q.layername,name:q.layername};if(null!==q.bbox[0]&&null!==q.bbox[1]&&null!==q.bbox[2]&&null!==q.bbox[3]){var W=c.proj.transformExtent(q.bbox,"EPSG:4326",K);V.extent=W}L=new c.layer.Tile(V)}M=q.geographic}M===!1&&(console.log("geographic tools disabled"),j=!0,a("#autolocate").hide());var X,Y=b.imageUrl("success_mark","treasurehunt"),Z=b.imageUrl("failure_mark","treasurehunt"),$=b.imageUrl("my_location","treasurehunt"),_=e.createGeocoder("openstreetmap"),aa={},ba=0,ca=0,da=[],ea=[],fa=!1,ga=!1,ha=!1,ia=!1,ja=!1,ka=!0,la=!1,ma=new c.style.Text({textAlign:"center",scale:1.3,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#000",width:3.5})}),na=new c.style.Text({textAlign:"center",scale:1.4,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#3399CC",width:3.5})}),oa=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:Y}),text:ma,zIndex:"Infinity"}),pa=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:Z}),text:ma,zIndex:"Infinity"}),qa=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:Y}),text:na,zIndex:"Infinity"}),ra=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:Z}),text:na,zIndex:"Infinity"}),sa=new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[0,0,0,1]}),stroke:new c.style.Stroke({color:[255,255,255,1],width:2})})}),ta=new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.3]}),stroke:new c.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),ua=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.35,src:$})}),va=[],wa=new c.format.GeoJSON,xa=new c.source.Vector({projection:"EPSG:3857"}),ya=new c.layer.Vector({source:xa,style:r}),za=new c.layer.Tile({visible:!1,source:new c.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});za.set("name",g.aerialview);var Aa=new c.layer.Tile({source:new c.source.OSM});Aa.set("name",g.roadview);var Ba=[],Ca=[];null!==q&&q.onlybase!==!1||(Ba=[za,Aa]),null!==L&&("overlay"!=q.layertype?Ba.push(L):Ca.push(L));var Da=new c.layer.Group({layers:Ba}),Ea=null;Da.getLayers().forEach(function(a){a.setVisible(!1),Ea=a}),Ea.setVisible(!0);var Fa=new c.View({center:[0,0],zoom:2,minZoom:2}),Ga=new c.interaction.Select({layers:[ya],style:s,filter:function(a,b){return 0!==a.get("stageposition")}}),Ha=new c.Feature;Ha.setProperties({name:"user_accuracy"}),Ha.setStyle(ta);var Ia=new c.Feature;Ia.setProperties({name:"user_position"}),Ia.setStyle(sa);var Ja=new c.layer.Vector({source:new c.source.Vector({features:[Ha,Ia]})}),Ka=new c.Feature;Ka.setGeometry(null),Ka.setStyle(ua);var La=new c.layer.Vector({source:new c.source.Vector({features:[Ka]})});va.push(Da),va=va.concat(Ca),va=va.concat([ya,Ja,La]);var Ma=new c.control.Zoom({target:"navigation",className:"custom-zoom"}),Na=new c.Map({layers:va,controls:[Ma],target:"mapplay",view:Fa,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});if(Na.addInteraction(Ga),w(!1,!0),X=setInterval(function(){w(!1,!1)},n),C(Da),Ca.forEach(function(a){B(a)}),o&&p){var Oa=f.addgpxlayer(Na,h,i,g,p,"trackgroup");Oa.set("name",Oa.get("title"));var Pa=Oa.getLayers().item(0),Qa=Pa.get("title"),Ra=Qa.substring(Qa.indexOf("</a>")+4);Pa.set("name",Ra),Pa.setVisible(!1),B(Pa)}var Sa=new c.Geolocation({projection:Fa.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});Sa.on("change:position",function(){var b=this.getPosition();Ia.setGeometry(b?new c.geom.Point(b):null),this.get("center")&&(v(Na,b),this.setProperties({center:!1})),this.get("validate_location")&&(w(!0,!1),this.setProperties({validate_location:!1})),a.mobile.loading("hide")}),Sa.on("change:accuracyGeometry",function(){Ha.setGeometry(this.getAccuracyGeometry()),a.mobile.loading("hide")});var Ta=!1;if(Sa.on("error",function(b){a.mobile.loading("hide"),Sa.setProperties({user_denied:!0}),F(b.message),b.code==b.PERMISSION_DENIED&&o&&!j&&0==Ta&&setTimeout(function(){a("#popupgeoloc").popup("open",{positionTo:"window"}),Ta=!0},500)}),Sa.setTracking(o),Ga.on("select",function(b){if(1===b.selected.length)if(aa.position===b.selected[0].get("stageposition")&&b.selected[0].get("geometrysolved")&&!ja&&ka)a("#infopanel").panel("open"),a("#lastsuccessfulstage").collapsible("expand");else{var c,d=b.selected[0].get("name"),e=b.selected[0].get("clue"),f=b.selected[0].get("info"),h="";b.selected[0].get("geometrysolved")?d&&e?(c=g.stageovercome,h=J(g.stagename,d),h+=J(g.stageclue,e)):c=g.discoveredlocation:c=g.failedlocation,f&&(h+="<p>"+f+"</p>"),G("infostage",c,h)}}),Na.on("click",function(a){var b=!1;if(Na.forEachFeatureAtPixel(Na.getEventPixel(a.originalEvent),function(a,c){return 0!==a.get("stageposition")&&"user_position"!==a.get("name")&&"user_accuracy"!==a.get("name")&&void(b=!0)}),j&&!b){var d=Na.getEventCoordinate(a.originalEvent);Ka.setGeometry(d?new c.geom.Point(d):null)}}),a("#autocomplete").on("filterablebeforefilter",function(b,d){if(M){var e=a(this),f=a(d.input).val(),h="";e.html(h),f&&f.length>2&&(a.mobile.loading("show",{text:g.searching,textVisible:!0,theme:"b"}),_.geocode(f,function(b){b[0]===!1?e.html("<li data-filtertext='"+f+"'>"+g.noresults+"</li>"):a.each(b,function(b,d){a("<li data-filtertext='"+f+"'>").hide().append(a("<a href='#'>").text(d.totalName).append(a("<p>").text(d.type))).appendTo(e).click(function(){var b=[];b[0]=parseFloat(d.boundingbox[2]),b[1]=parseFloat(d.boundingbox[0]),b[2]=parseFloat(d.boundingbox[3]),b[3]=parseFloat(d.boundingbox[1]),b=c.proj.transformExtent(b,"EPSG:4326","EPSG:3857"),v(Na,null,b),a("#searchpanel").panel("close")}).show()}),e.listview("refresh"),e.trigger("updatelayout"),a.mobile.loading("hide")}))}}),a("#infopanel").on("collapsibleexpand","[data-role='collapsible']",function(b,c){var d=a("#infopanel .ui-panel-inner");d.animate({scrollTop:parseInt(a(this).offset().top-d.offset().top+d.scrollTop())},500)}),a(document).on("popupbeforeposition",function(){var b=a(window).height()-200+"px";a('.ui-popup [data-role="content"]').css("max-height",b)}),a(document).on("popupafterclose",".ui-popup:not(#QRdialog):not(#popupdialog):not(#popupgeoloc)",function(){a(this).remove(),Ga.getFeatures().clear()}),a(document).on("click","#acceptupdates",function(){da=[]}),a(window).on("pagecontainershow resize",function(b,c){a.mobile.resetActivePageHeight();var d=a.mobile.pageContainer.pagecontainer("getActivePage").prop("id");"mappage"===d?"resize"===b.type?setTimeout(function(){Na.updateSize()},200):(Na.updateSize(),y(),x()):"historypage"===d?"pagecontainershow"===b.type&&A():"questionpage"===d&&"pagecontainershow"===b.type&&(""===aa.question?a.mobile.pageContainer.pagecontainer("change","#mappage"):z())}),M&&a("#autolocate").on("click",function(){Sa.get("user_denied")?a("#popupgeoloc").popup("open",{positionTo:"window"}):u(!0)}),a("#infopanel").panel({beforeclose:function(){Ga.getFeatures().clear()}}),a("#sendLocation").on("click",function(){t(!0)}),a("#sendAnswer").on("click",function(b){var c=a("#questionform input[type='radio']:checked");ka?0===c.length?(b.preventDefault(),F(g.noanswerselected)):w(!1,!1,c.val()):(b.preventDefault(),F(g.timeexceeded))}),a("#validatelocation").on("click",function(b){return ja?(b.preventDefault(),void F(g.huntcompleted)):ka?""!==aa.question?(b.preventDefault(),F(g.answerwarning),void a("#infopanel").panel("open")):aa.activitysolved?void 0:(b.preventDefault(),F(g.activitytoendwarning),void a("#infopanel").panel("open")):(b.preventDefault(),void F(g.timeexceeded))}),a.mobile.autoInitializePage===!1){a("#container").show(),a("#loader").remove(),a.mobile.initializePage();var Ua=document.querySelector("meta[name=viewport]");Ua.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"),a("#QRdialog").popup({beforeposition:function(b,c){a(this).width(.9*window.innerWidth),a(this).height(.9*window.innerHeight)},afteropen:function(b,c){var d=a(this).find("div[data-role='content']").first(),e=a(this).find("div[data-role='header']").first(),f=parseInt(d.css("padding-top"))+parseInt(d.css("padding-bottom"));d.css("max-height","1000px"),a("#previewVideoDiv").width(a(this).width()-f).height(a(this).height()-a("#previewQRbuttons").height()-e.height()-2*f),a('#previewQRvideo').show(),loadQR(D,E)},afterclose:function(a,b){unloadQR(E)}})}a("#nextcamera").on("click",function(){if(null!==detectedCameras){var a=getnextwebCam();F("Give access to:"+detectedCameras[a].name)}setnextwebcam(E)})}console.log("loading play.js");var i={playtreasurehunt:function(a,b,c,d,e,f,i,j,k,l){var m=["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error"];console.log("loading i18n strings");var n=m.map(function(a){return{key:a,component:"treasurehunt"}});g.get_strings(n).done(function(g){for(var n=[],o=0;o<m.length;o++)n[m[o]]=g[o];if("undefined"!=typeof l&&null!==l&&null!==l.custombackgroundurl){console.log("detecting custom background image dimensions.");var p=new Image;p.addEventListener("load",function(){l.imgwidth=this.naturalWidth,l.imgheight=this.naturalHeight,console.log("image is "+this.naturalWidth+"x"+this.naturalHeight+"pixels"),h(n,a,b,c,d,e,f,i,j,k,l)}),p.src=l.custombackgroundurl}else h(n,a,b,c,d,e,f,i,j,k,l)})}};return i});
