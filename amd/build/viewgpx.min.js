define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","mod_treasurehunt/ol3-layerswitcher","core/str"],function(S,e,t,r,I,n,c){var M=30,P=0;return{addgpxlayer:function(e,t,r,n,a,o){var i=function(e,t){var r=null;e.getLayers().forEach(function(e){e.get("title")==t&&(r=e)}),r||(r=new I.layer.Group({title:t,layers:[]}),e.addLayer(r));return r}(e,o);return G([a],t,e,i,null),i},creategpxviewer:function(a,o,i,l,e){var u=["aerialmap","roadmap","basemaps","searchlocation","trackviewer"],t=u.map(function(e){return{key:e,component:"treasurehunt"}});M=e,c.get_strings(t).done(function(e){for(var t=[],r=0;r<u.length;r++)t[u[r]]=e[r];if(null!=l&&null!==l.custombackgroundurl){var n=new Image;n.addEventListener("load",function(){l.imgwidth=this.naturalWidth,l.imgheight=this.naturalHeight,s(a,o,t,i,l)}),n.src=l.custombackgroundurl}else s(a,o,t,i,l)})}};function s(e,t,r,n,a){var o="EPSG:3857",i=null;if(void 0!==a&&null!=a){if(null!=a.custombackgroundurl){var l=I.proj.transformExtent(a.bbox,"EPSG:4326",o);if(!a.geographic){l[2],l[0];var u=l[3]-l[1],c=(l[2]+l[0])/2,s=(l[3]+l[1])/2,m=Math.round(u/a.imgheight),g=Math.round(a.imgwidth*m),h=Math.round(a.imgheight*m);l=[c-g/2,s-h/2,c+g/2,s+h/2]}i=new I.layer.Image({title:a.layername,type:a.layertype,source:new I.source.ImageStatic({url:a.custombackgroundurl,imageExtent:l}),opacity:1})}else if(null!=a.wmsurl){var y={source:new I.source.TileWMS({url:a.wmsurl,params:a.wmsparams}),type:a.layertype,title:a.layername};if(null!=a.bbox[0]&&null!=a.bbox[1]&&null!=a.bbox[2]&&null!=a.bbox[3]){var d=I.proj.transformExtent(a.bbox,"EPSG:4326",o);y.extent=d}i=new I.layer.Tile(y)}a.geographic}var f=new I.layer.Group({title:r.basemaps,layers:[new I.layer.Tile({title:r.aerialmap,type:"base",visible:!1,source:new I.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new I.layer.Tile({title:r.roadmap,type:"base",visible:!0,source:new I.source.OSM})]});null!==i&&(a.onlybase&&f.getLayers().clear(),f.getLayers().push(i));var p=new I.layer.Group({title:r.trackviewer,layers:[]}),w=(new I.layer.Heatmap({title:"Heatmap",source:new I.source.Vector({url:"gpx.php?id="+e+"&userid=24",format:new I.format.GPX}),blur:20,radius:10}),new I.control.LayerSwitcher),v=new I.Map({layers:[f,p],renderer:"canvas",target:document.getElementById("mapgpx"),view:new I.View({center:[0,0],zoom:2,minZoom:2}),controls:I.control.defaults().extend([w])});w.showPanel();var b=new I.interaction.Select({style:function(e){return L(e,b.getLayer(e).iconurl,!0)}});v.addInteraction(b),G(n,e,v,p,w);var x=new I.Overlay({element:document.getElementById("info")});function k(e){var t=x.getElement(),r=e.coordinate;S(t).popover("destroy"),x.setPosition(r),S(t).popover({placement:"top",animation:!1,html:!0,content:function(e){var t=[],r="";if(v.forEachFeatureAtPixel(e,function(e){t.push(e)}),0<t.length){var n,a,o=[];for(n=0,a=t.length;n<a;++n)o.push(t[n].get("desc"));r=o.join(", ")||"(unknown)",v.getTarget().style.cursor="pointer"}else v.getTarget().style.cursor="";return r}(v.getEventPixel(e.originalEvent))}),S(t).popover("show")}v.addOverlay(x),v.on("pointermove",function(e){e.dragging}),v.on("click",function(e){k(e)});var E=null;S("#refreshtracks").change(function(){S(this).is(":checked")?(P=0,S("#timecircle").show(),E=setInterval(function(){S("#timecircle").text(M-P++%M)},1e3)):(S("#timecircle").hide(),clearInterval(E))})}function m(e,t,r){var n=e.getView();r?n.fit(r,{duration:700}):n.animate({zoom:19,center:t,duration:700})}function G(e,i,l,u,c){var s=null;e.forEach(function(e){var t=new I.source.Vector({url:"gpx.php?id="+i+"&userid="+e.id,format:new I.format.GPX}),r=e.pic.indexOf('<img src="')+10,n=e.pic.indexOf('"',r),a=e.pic.substring(r,n),o=new I.layer.Vector({source:t,title:e.pic+""+e.fullname,style:function(e){return L(e,a,!1)}});o.iconurl=a,setInterval(function(){S("#refreshtracks").is(":checked")&&(P=0,t.clear(),t.refresh())},1e3*M),o.on("change:visible",function(){if(this.getVisible()){var e=this.getSource().getExtent();m(l,null,e)}}),t.on("change",function(){if(!S("#refreshtracks").is(":checked")){var e=t.getExtent();null===s?s=e:(s[0]=Math.min(s[0],e[0]),s[1]=Math.min(s[1],e[1]),s[2]=Math.max(s[2],e[2]),s[3]=Math.max(s[3],e[3])),m(l,null,s)}},this),u.getLayers().push(o),c&&c.renderPanel()})}function L(e,t,r){var n=[new I.style.Style({stroke:new I.style.Stroke({color:"rgba(255,255,255,0.8)",width:6+2*r}),zIndex:1+4*r}),new I.style.Style({stroke:new I.style.Stroke({color:"#ff0000",width:1+r,lineDash:[10,8]}),fill:new I.style.Fill({color:"rgba(255,0,0,0.5)"}),zIndex:2+4*r}),new I.style.Style({image:new I.style.Circle({radius:3+2*r,stroke:new I.style.Stroke({color:"white",width:1+r}),fill:new I.style.Fill({color:"red"})}),geometry:function(e){var t=e.getGeometry().getCoordinates()[0];return new I.geom.MultiPoint(t)},zIndex:3+4*r})],a=e.getGeometry().getLastCoordinate();return n.push(new I.style.Style({geometry:new I.geom.Point(a),image:new I.style.Icon({src:t,anchor:[.75,.5],rotateWithView:!1}),zIndex:4+4*r})),n}});